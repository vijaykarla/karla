!function(){function p(){q(!1)}function q(i){if(d=new Date(peptrack.EventTime),e=[{Latitude:peptrack.Latidue,Longitude:peptrack.Longitude,EventTime:peptrack.EventTime,TrackId:peptrack.TrackId,GroundSpeed:peptrack.GroundSpeed}],u(),v(),y(),clearTimeout(a),clearTimeout(b),clearTimeout(c),r(),i){f=new pepMap(peptrack.Latidue,peptrack.Longitude),f.initialize();var k=document.getElementById("pep-distance").getContext("2d");g=new odometer(k,{height:25,digits:4,decimals:1,value:j,wobbleFactor:0});var m=document.getElementById("pep-altitude").getContext("2d");h=new odometer(m,{height:25,digits:4,decimals:1,value:l,wobbleFactor:0})}}function r(){var b=new Date(peptrack.EventTime);s(b.toUTCString()),a=setTimeout(function(){t()},i)}function s(a){var b=peptrack.DomainName+"api/"+peptrack.ApiVersion+"/data/locations/id/"+peptrack.TrackId+"?trackdate="+a+"&direction=back-1&token="+peptrack.Token;""!=peptrack.PrivateCode&&(b+="&code="+peptrack.PrivateCode),jQuery.ajax({headers:{Accept:"application/json; charset=utf-8","Content-Type":"application/json; charset=utf-8"},url:b,type:"GET",contentType:"application/json; charset=utf-8",success:function(a){if(a&&void 0!=a&&a.length>0){var b=new Date(a[0].EventTime);if(void 0==d||d.getTime()!=b.getTime()){var c=a[0];c&&c.Latitude&&c.Longitude&&(e.length>1&&e.splice(1,1),e.unshift(c),B(!1))}}},error:function(a,b,c){},timeout:i})}function t(){var b=peptrack.DomainName+"api/"+peptrack.ApiVersion+"/data/location/id/"+peptrack.TrackId+"?token="+peptrack.Token;""!=peptrack.PrivateCode&&(b+="&code="+peptrack.PrivateCode),jQuery.ajax({headers:{Accept:"application/json; charset=utf-8","Content-Type":"application/json; charset=utf-8"},url:b,type:"GET",contentType:"application/json; charset=utf-8",success:function(a){if(a&&a.Latitude&&a.Longitude){var b=[parseFloat(a.Latitude),parseFloat(a.Longitude)],c=new Date(a.EventTime);if(void 0==d||d.getTime()!=c.getTime()){peptrack.Latidue=a.Latitude,peptrack.Longitude=a.Longitude,peptrack.EventTime=a.EventTime,e.length>1&&e.splice(0,1),e.push(a),C(k,!0),B(!0),C(k,!1),u(),o=0,v(),y();var g=parseFloat(a.Elevation);0==m&&0!=g?F(g+15,!0):F(m,!0),0!=g?(peptrack.Elevation=g,m=g,F(g,!1)):(peptrack.Elevation=n,m=n,F(n,!1)),clearTimeout(pepMap.markerTimeout),f.transition(b)}d=c}},error:function(a,b,c){},timeout:i}),a=setTimeout(function(){t()},i)}function u(){var a={weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"};$("#pep-date").html(d.toLocaleString("en-us",a))}function v(){if(e.length>0){currentlocation=e[e.length-1];var a=currentlocation.Latitude,b=currentlocation.Longitude;if(e.length>1){var c=e[e.length-2],g=(c.Latitude,c.Longitude,A(e[e.length-2],e[e.length-1]));if(g<.01)return}var h=peptrack.DomainName+"api/"+peptrack.ApiVersion+"/data/address?latitude="+a+"&longitude="+b+"&token="+peptrack.Token;jQuery.ajax({headers:{Accept:"application/json; charset=utf-8","Content-Type":"application/json; charset=utf-8"},url:h,type:"GET",contentType:"application/json; charset=utf-8",success:function(a){if(a){o=0;var b=a.Address,c=a.Province,d=a.Country,e=parseFloat(a.Distance);a.Elevation&&null!=a.Elevation&&(n=parseFloat(a.Elevation));var f="";if(e>1e3){var g=e/1e3;g=g.toFixed(1),f=g+" Km"}else f=Math.round(e)+" metres";var h=f+" away from<br/>";h+=b+"<br/>",void 0!=c&&(h+=c+"<br/>"),void 0!=d&&(h+=d);var b='<span style="font-weight: bold; color:red">'+f+" away from:</span>";b+='<br/><span style="color:#6600cc;">'+a.Address,"Unknown"!=a.Province&&(b+="<br/>"+a.Province),void 0!=a.PostalCode&&(b+=" "+a.PostalCode),"Unknown"!=a.Country&&(b+="<br/>"+a.Country),b+="</span>",$("#pep-address").show(),$("#pep-address").html(b)}else o<5&&(o++,v())},error:function(a,b,c){o<5&&(o++,v())},timeout:i})}}function w(a){var b=$(".selected");return b.removeClass("selected"),a.addClass("selected"),y(),!1}function y(){if(e.length>0){var a=$(".selected"),b=a.attr("data-location"),c=b.split(","),d={Latitude:parseFloat(c[0]),Longitude:parseFloat(c[1])},f=A(e[e.length-1],d);if(x<0&&(x=f),x>0){var g=100-Math.round(f/x*100);g<=100&&g>0&&$(".divpointer").css({left:g.toString()+"%"})}else 0==x?$(".divpointer").css({left:"99%"}):x<0&&$(".divpointer").css({left:"0%"});initDist=f;var h="";if(f>1){var i=f.toFixed(1);h=i+" Km"}else h=Math.round(1e3*f)+" metres";h+=" away from ";var j=a.html();$("#spndistance").html(h),$("#spnpoit").html(j)}}function A(a,b){var c=6371,d=(b.Latitude-a.Latitude)*Math.PI/180,e=(b.Longitude-a.Longitude)*Math.PI/180,f=Math.sin(d/2)*Math.sin(d/2)+Math.cos(a.Latitude*Math.PI/180)*Math.cos(b.Latitude*Math.PI/180)*Math.sin(e/2)*Math.sin(e/2),g=2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f)),h=c*g;return h}function B(a){null==z&&(z=new Gauge("pep-speed",{mode:"needle",range:{min:0,max:180}}));var b=0;if(e.length>1){b=Math.round(parseFloat(e[e.length-1].GroundSpeed));var c,d,f;c=e[e.length-1],d=e[e.length-2];var f=A(c,d);if(f>=0){var g=new Date(c.EventTime),h=new Date(d.EventTime),i=g-h;if(i>0){var j=i/1e3/60/60;0==b&&(b=Math.round(f/j)),a&&(j<8?k+=f:k=0)}}}else e.length>0&&(b=Math.round(parseFloat(e[e.length-1].GroundSpeed)));b||(b=0),peptrack.GroundSpeed=b,b>=0&&b<=180?z.draw(b):b<0?z.draw(0):b>180&&z.draw(180)}function C(a,c){c?(clearTimeout(b),j=a):j+=.005,j>a&&(j=a),g.setValue(j),j<a&&(b=setTimeout(function(){C(a,c)},100))}function D(){clearTimeout(b),k=0,j=0,C(0,!0)}function F(a,b){b?(E=0,clearTimeout(c),l=a):a>l?l+=.01:a<l&&(l-=.01),h.setValue(l);var d=a-l;(d<-.02||d>.02)&&(E++,E>1500&&(E=0,clearTimeout(c),l=a),c=setTimeout(function(){F(a,b)},10))}function H(){$("#pointpopup").hide(),$("#overlay").hide()}function I(){$("#pointpopup").on("click","a",function(a){var b=$(a.target);w(b)})}var a,b,c,e,f,g,h,d=void 0,i=16e3,j=0,k=0,l=peptrack.Elevation,m=l,n=0,o=0;window.onfocus=p;var x=-1,z=null,E=0;$(document).ready(function(){$("#divhouse").click(function(){}),$("#spnpoit").click(function(){}),$("#spndistance").click(function(){}),$("#overlay").click(function(){H()}),$("#imgreset").click(function(){D()}),I(),q(!0)})}();
